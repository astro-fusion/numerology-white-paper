name: Deploy Research Platform

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      deploy_type:
        description: 'Deployment type'
        required: true
        default: 'full'
        type: choice
        options:
          - full
          - static-only
          - app-only
          - docs-only

# Sets permissions for deployment
permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "research-platform"
  cancel-in-progress: false

jobs:
  build:
    name: Build Content
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup Pages
      uses: actions/configure-pages@v4

    - name: Set up Quarto
      uses: quarto-dev/quarto-actions/setup@v2
      with:
        tinytex: true

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.10"

    - name: Cache pip dependencies
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-pages-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-pages-

    - name: Install system dependencies
      run: sudo apt-get update && sudo apt-get install -y libswisseph-dev

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -e ".[dev]"
        pip install pyswisseph>=2.08.00 sphinx sphinx-rtd-theme myst-parser

    # Build manuscripts (HTML, PDF, DOCX)
    - name: Build Manuscripts
      if: github.event.inputs.deploy_type != 'docs-only' || github.event_name == 'push'
      run: |
        echo "Building manuscripts..."
        ./build.sh html
        ./build.sh pdf
        ./build.sh docx

    # Build API documentation
    - name: Build API Documentation
      if: github.event.inputs.deploy_type != 'manuscripts-only' || github.event_name == 'push'
      run: |
        echo "Building API documentation..."
        mkdir -p docs/api
        python -m sphinx -b html docs/ docs/_build/html

    # Create combined site structure
    - name: Create Site Structure
      run: |
        mkdir -p _site

        # Copy manuscript HTML as main content
        if [ -f "_book/html/manuscript.html" ]; then
          cp _book/html/manuscript.html _site/index.html
          cp -r _book/html/* _site/ 2>/dev/null || true
        fi

        # Copy API documentation
        if [ -d "docs/_build/html" ]; then
          mkdir -p _site/docs
          cp -r docs/_build/html/* _site/docs/
        fi

        # Create navigation page
        cat > _site/index.html << 'EOF'
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>Vedic Numerology-Astrology Integration System</title>
            <style>
                body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
                .hero { text-align: center; margin: 40px 0; }
                .cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin: 40px 0; }
                .card { border: 1px solid #ddd; border-radius: 8px; padding: 20px; text-align: center; }
                .card h3 { margin-top: 0; }
                .btn { display: inline-block; padding: 10px 20px; background: #007bff; color: white; text-decoration: none; border-radius: 5px; }
                .btn:hover { background: #0056b3; }
            </style>
        </head>
        <body>
            <div class="hero">
                <h1>ğŸª Vedic Numerology-Astrology Integration System</h1>
                <p>Computational analysis of planetary influences on numerological potentials</p>
            </div>

            <div class="cards">
                <div class="card">
                    <h3>ğŸ“– Research Manuscript</h3>
                    <p>Complete research paper with integrated analysis results</p>
                    <a href="manuscript.html" class="btn">Read Manuscript</a>
                    <br><br>
                    <a href="manuscript.pdf" class="btn" target="_blank">ğŸ“„ Download PDF</a>
                </div>

                <div class="card">
                    <h3>ğŸ”§ API Documentation</h3>
                    <p>Complete API reference for developers</p>
                    <a href="docs/index.html" class="btn">View API Docs</a>
                </div>

                <div class="card">
                    <h3>ğŸ’» Source Code</h3>
                    <p>GitHub repository with implementation</p>
                    <a href="https://github.com/astro-fusion/numerology-white-paper" class="btn" target="_blank">View on GitHub</a>
                </div>

                <div class="card">
                    <h3>ğŸ“Š Interactive Examples</h3>
                    <p>Try the system in Google Colab</p>
                    <a href="https://colab.research.google.com/github/astro-fusion/numerology-white-paper/blob/main/notebooks/01_numerology_calculations.ipynb" class="btn" target="_blank">Open in Colab</a>
                </div>
            </div>

            <footer style="text-align: center; margin-top: 40px; color: #666;">
                <p>Â© 2025 Bishal Ghimire. Built with Quarto and Sphinx.</p>
            </footer>
        </body>
        </html>
        EOF

    - name: Upload artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: _site

  deploy:
    name: Deploy to GitHub Pages
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build

    steps:
    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4